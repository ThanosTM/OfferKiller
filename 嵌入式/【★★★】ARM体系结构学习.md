## 冯诺依曼架构与哈佛架构
#### 哈佛架构
将程序指令存储和数据存储分开，可以使指令和数据具有不同的数据位宽。哈佛架构的特点是具有较高的执行效率，减轻了程序的访存瓶颈。

#### 冯诺依曼架构
又称为普林斯顿架构，在哈佛架构之后被提出，思想是“代码本身也是一种数据”，处理器使用同一存储器，经由同一个总线传输，因此传输速度变慢了。

#### 改进的哈佛架构
![image](https://pic3.zhimg.com/80/v2-37a5331df99d157b709c0674efcad882_720w.jpg)

芯片内部采用哈佛结构，而对外的接口采用冯诺依曼结构，充分结合了两者的优点。


## ARM的9种工作模式
![image](https://img-blog.csdn.net/20160627154926556?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

- 用户模式（USR）：正常程序的执行模式，不能直接切换到其他模式
- 系统模式（SYS）：运行操作系统的特权任务
- 快速中断模式（FIQ）：支持高速数据传输及通道处理，FIQ异常响应时进入该模式；
- 中断模式（IRQ）：用于通用的中断处理，IRQ异常响应时进入该模式；
- 管理模式（SVC）：操作系统保护模式，系统复位或软件中断响应时进入该模式；
- 终止模式（ABT）：内存访问异常处理模式，常见的MMU Fault就会进入该模式；
- 未定义模式（UND）：当执行未定义的指令时，触发硬件异常；
- Monitor：针对安全扩展，在该模式下进行secure和non-secure处理器的切换
- Hypervisor：针对虚拟化的扩展

#### 硬件权限级别
系统模式 > 异常模式 > 用户模式

#### 快速中断的快体现在：
- 更多的寄存器：FIQ独享R8~R12，意味着更多的数据处理可以在寄存器中执行；
- 更高的优先级：FIQ和IRQ同时到达时，FIQ会首先得到响应；同时FIQ应该要支持抢占IRQ运行，而且不应该被其他异常所抢占；
- 放在中断向量表的最后：观察一下中断向量表可以发现，FIQ位于中断向量表的最后，这是因为其他入口都需要一条跳转指令到别的地方执行，而FIQ的处理代码可以直接放在中断向量表之后，避免了跳转指令。
- 更低的时延：中断信号产生到执行中断处理的第一条指令的延时时间，这是由硬件决定的。

#### Linux操作系统与ARM工作模式
ARM芯片上电后会首先进入SVC模式，此时PC会被赋值为0x0，bootloader被首先执行，引导Linux内核的启动；此时Linux内核同样运行在SVC模式下，当内核启动完毕，进入Init用户态进程时，设置CPSR寄存器相应位进入用户模式。

## ARM架构的寄存器
共37个寄存器，32位长度，30个通用型，一个固定用作PC，一个固定用作CPSR，5个固定用作异常模式下的SPSR.
![image](https://pic2.zhimg.com/80/v2-37c99d9a32d642d3851fc4b750e0bbf1_720w.jpg)

#### R0~R7
所用工作模式下，使用的都是同一组物理寄存器，未被系统用作特殊的用途，在中断或异常发生后模式发生转换时，不同工作模式均使用相同的物理寄存器。

#### R8~R12
除了FIQ模式下，访问的也是同一组物理寄存器。在快速中断模式下，R8~R12为其独有的，这样可以减少中断现场保护带来的时间开销，以达到快速响应中断的效果。

#### R13
在每个模式中拥有各自独立的寄存器，R13在ARM指令中常用作堆栈指针SP，但这是一种习惯的用法，用户理论上可以使用其他寄存器，但是在Thumb指令集中，某些指令强制要求R13作为堆栈指针。一般先要初始化各种模式下的R13，使其指向该工作模式下的栈空间，当程序进入异常时，可以将需要保护的寄存器压栈，返回时进行弹栈，从而实现现场的保护与恢复。

#### R14
R14被称为链接寄存器LR，当执行子程序调用指令时（BL），R14得到R15的备份，当执行完子程序返回时，将R14的值赋给R15.

#### R15
R15用作程序计数器PC，所有工作模式的R15均为同一个物理寄存器，由于ARM的流水线技术，PC总是指向当前指令的下两条指令的地址，即+8

#### CPSR和SPSR
CPSR即当前程序状态寄存器，可以被任何工作模式访问，包含一些条件标志位、中断禁止位、模式标志位等；当异常发生时，SRPR保存CPSR的值，便于从异常退出时恢复CPSR.

![image](https://pic4.zhimg.com/80/v2-7bec1a4020a0e4f6c015926ff4946893_720w.png)

- M[4:0]：模式位，对应9种模式的处理器编码
- T：是否使用Thumb指令
- F：1-禁用FIQ模式
- I：1-禁用IRQ模式
- A：1-禁用Abort模式
- E：大小端选择，0-小端
- IT[7:2]、IT[1:0]：针对ThumbEE中的一些条件判断的执行
- GE[3:0]：SIMD指令的使用
- J：1-启用Java加速
- Q=1：累计饱和
- V=1：ALU操作溢出
- C=1：ALU进位操作
- Z=1：ALU结果为0
- N=1：ALU结果为负数


## 中断向量表
ARM架构的芯片上电后执行的第一条语句是0x0处的代码，从0x0处存放的是以4个字节为单位的地址，当芯片处于不同的状态时，就会根据这段内容跳转到对应的地址去执行对应的程序。
```
_start:
	ldr pc, =Reset_Handler /* 复位中断 */
	ldr pc, =Undefined_Handler /* 未定义指令中断 */
	ldr pc, =SVC_Handler /* SVC(Supervisor)中断 */
	ldr pc, =PrefAbort_Handler /* 预取终止中断 */
	ldr pc, =DataAbort_Handler /* 数据终止中断 */
	ldr pc, =NotUsed_Handler /* 未使用中断 */
	ldr pc, =IRQ_Handler /* IRQ 中断 */
	ldr pc, =FIQ_Handler /* FIQ(快速中断)未定义中断 */
	# 此处省略好多

/* 复位中断 */
Reset_Handler:
	# 此处再省略好多
	b main /* 跳转到 main 函数 *
```

